Input:N1(50),N2(50),UP(1),DN(3),Len(30),StdN(30),Swit(0.9);
var:hh(0),ll(0),MP(0),AvgR(0),Std(0),CP(0);
MP=marketposition*currentcontracts;


STD=StandardDev(c,Len, 1);
IF STD[StdN]<>0 then
CP=STD/STD[StdN];

value1=Average(C,N1);
value2=StandardDev(value1,N1,1);

value3=Average(C,N2);
value4=StandardDev(value1,N2,1);

hh=value1+ (value2*UP);
ll=value3- (value4*DN);

//順勢
IF CP<Swit then begin
 IF marketposition<>1  and C crosses over hh  then buy("BB") next bar at market;
 IF marketposition<>-1 and C crosses under ll  then sellshort("SS") next bar at market;

 input: BMax(100),BTB(50),SMax(100), STB(50);

 var:wimax( 0 ) ;
 if MP<>0
   then wimax=maxpositionprofit/bigpointvalue/currentcontracts;

 if MP<>MP[1] then wimax=0;

 if MP>0 and wimax>=BMax
   then sell next bar entryprice+wimax-BTB  stop;

 if MP<0 and wimax>=SMax
  then buytocover next bar entryprice-wimax+STB  stop;

 inputs:  BB(70),SS(70) ;
 variables: varBB( 0 ),varSS(0) ;

 varBB = AverageFC( C,BB ) ;
 varSS = AverageFC( C,SS ) ;

 if MP= 1 and C > varBB
  then Sell  Next Bar varBB Stop;

 if MP=-1 and C < varSS 
  then Buytocover  Next Bar varSS Stop;

end;

//逆勢
IF CP>Swit then begin

 IF marketposition<>1  and C crosses over ll  then buy("BB-") next bar at market;
 IF marketposition<>-1 and C crosses under hh then sellshort("SS-") next bar at market;

 inputs: LB2(200),WB2(400),LS2(200),WS2(400);

 if marketposition>0 then begin
   sell next bar entryprice(0)- (minmove/pricescale)*LB2 stop;  
   sell next bar entryprice(0)+(minmove/pricescale)*WB2 limit;
 end; 

 if marketposition<0 then begin
   buytocover next bar entryprice(0)+(minmove/pricescale)*LS2 stop;  
   buytocover next bar entryprice(0)- (minmove/pricescale)*WS2 limit;  
end;